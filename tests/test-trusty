#!/usr/bin/env bash

# This is a bash utility to test the script in docker container
# Version:1.0
# Author: Prasad Tengse
# Licence: GPLv3
# Github Repository: https://github.com/tprasadtp/after-effects-ubuntu

set -o pipefail
function main()
{
  dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
  #shellcheck disable=SC2116
  dir=$(echo "${dir/tests/}")
  log_file="$dir"/after-effects-logs/after-effects.log
  # set eo on script.
  #sed -i 's/set -o pipefail/set -eo pipefail/g' "$dir"/after-effects
  echo "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
  echo "Testing On HOST"
  echo "Remove peek, kdeconnect-indicator PPAs"
  sed -i '/peek-developers\|indicator-kdeconnect/d' ./data/ppa.list
  sed -i '/openjdk-8-jdk/d' ./data/development.list
  sed -i '/gnome-calendar\|gnome-todo\|polari/d' ./data/productivity.list
  sed -i '/indicator-kdeconnect\|peek\|yubikey-manager-qt/d' ./data/extern-repo.list
  sudo ./after-effects --yes --simulate --enable-pre --enable-post

  exit_code_from_script=$?
  echo "Exit code from  run is: $exit_code_from_script"
  echo "Print Logs is set to: $PRINT_LOGS"
  if [ "$PRINT_LOGS" == "true" ] || [[ "$exit_code_from_script" -gt 0 ]]; then
    echo " "
    echo " "
    echo "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
    cat "$log_file"
  fi
  return "$exit_code_from_script"
}

main "$@"
